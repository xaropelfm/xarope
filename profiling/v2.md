# V2

## Benchmark

```bash
➜ hyperfine --warmup 3 './target/release/xarope samples/100M.csv'
Benchmark 1: ./target/release/xarope samples/100M.csv
  Time (mean ± σ):     13.162 s ±  0.183 s    [User: 12.578 s, System: 0.548 s]
  Range (min … max):   12.925 s … 13.610 s    10 runs
```

## CPU profiling

```bash
➜ perf record -g --call-graph dwarf ./target/release/xarope samples/100M.csv

➜ perf report --stdio --no-children 2>/dev/null | grep -E "^\s+[0-9]" | head -10
    15.19%  xarope   xarope             [.] <csv::reader::StringRecordsIter<R> as core::iter::traits::iterator::Iterator>::next
    15.12%  xarope   xarope             [.] core::hash::BuildHasher::hash_one
    12.32%  xarope   xarope             [.] csv::byte_record::ByteRecord::validate
    12.13%  xarope   xarope             [.] xarope::main
    11.96%  xarope   xarope             [.] csv_core::reader::Reader::read_record
     5.28%  xarope   xarope             [.] core::hash::BuildHasher::hash_one
     4.94%  xarope   xarope             [.] <rust_decimal::decimal::Decimal as num_traits::cast::ToPrimitive>::to_u64
     3.79%  xarope   xarope             [.] core::str::<impl str>::trim_matches
     2.49%  xarope   libc.so.6          [.] cfree@GLIBC_2.2.5
     2.26%  xarope   libc.so.6          [.] malloc
```

## Memory profiling

```bash
➜ heaptrack ./target/release/xarope samples/100M.csv

➜ heaptrack_print heaptrack.xarope.*.zst 2>/dev/null | grep -E "^(total|peak|leaked|calls)"
total runtime: 44.72s.
calls to allocation functions: 300000072 (6708559/s)
peak heap memory consumption: 1.71G
peak RSS (including heaptrack overhead): 1.69G
total memory leaked: 456B

➜ heaptrack_print heaptrack.xarope.*.zst 2>/dev/null | \
                      awk '/^[0-9]+ calls/{call=$0; getline; gsub(/^ +/,"",$0); print call " " $0}' | head -10

300000006 calls to allocation functions with 453B peak consumption from _$LT$csv..reader..StringRecordsIter$LT$R$GT$$u20$as$u20$core..iter..traits..iterator..Iterator$GT$::next::hf2e58cd5f5fe02f4
100000000 calls with 88B peak consumption from: xarope::main::h51de490f0345b0eb
100000000 calls with 32B peak consumption from: xarope::main::h51de490f0345b0eb
100000000 calls with 29B peak consumption from: xarope::main::h51de490f0345b0eb
1 calls with 88B peak consumption from: xarope::main::h51de490f0345b0eb
1 calls with 32B peak consumption from: xarope::main::h51de490f0345b0eb
25 calls to allocation functions with 1.71G peak consumption from _ZN9hashbrown3raw21RawTable$LT$T$C$A$GT$14reserve_rehash17h4aa449f58657c4ecE.llvm.16912465404635488967
25 calls with 1.71G peak consumption from: _$LT$std..collections..hash..map..HashMap$LT$K$C$V$GT$$u20$as$u20$xarope..HashMapInsertUniqueExt$LT$K$C$V$GT$$GT$::insert_unique::h810c3e9f0beead17
11 calls to allocation functions with 102.42K peak consumption from _ZN9hashbrown3raw21RawTable$LT$T$C$A$GT$14reserve_rehash17hc9d5fe77fce87d98E.llvm.16912465404635488967
8 calls with 102.42K peak consumption from: _$LT$std..collections..hash..map..HashMap$LT$K$C$V$GT$$u20$as$u20$xarope..HashMapInsertUniqueExt$LT$K$C$V$GT$$GT$::insert_unique::h4673a4c60f7e61e
```

## Results

This version:
- Avoids double trimming of the CSV which was the main CPU overhead of V1.
- Uses "manual" triming on individual `&str` fields, which is much cheaper than what was previously done.
- Eliminates serde deserialization overhead
- ~ 40% faster
- ~ 50% less allocations 
