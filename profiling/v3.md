# V3

## Benchmark

```bash
➜ hyperfine --warmup 3 './target/release/xarope samples/100M.csv'
Benchmark 1: ./target/release/xarope samples/100M.csv
  Time (mean ± σ):     10.946 s ±  0.059 s    [User: 10.405 s, System: 0.514 s]
  Range (min … max):   10.822 s … 11.038 s    10 runs
```

## CPU profiling

```bash
➜ perf record -g --call-graph dwarf ./target/release/xarope samples/100M.csv

➜ perf report --stdio --no-children 2>/dev/null | grep -E "^\s+[0-9]" | head -10
    28.73%  xarope   xarope             [.] <csv::reader::StringRecordsIter<R> as core::iter::traits::iterator::Iterator>::next
    25.37%  xarope   xarope             [.] csv_core::reader::Reader::read_record
    12.11%  xarope   xarope             [.] xarope::main
     6.41%  xarope   xarope             [.] <rust_decimal::decimal::Decimal as num_traits::cast::ToPrimitive>::to_u64
     4.86%  xarope   xarope             [.] core::str::<impl str>::trim_matches
     2.69%  xarope   libc.so.6          [.] cfree@GLIBC_2.2.5
     2.64%  xarope   xarope             [.] csv::byte_record::ByteRecord::validate
     2.45%  xarope   libc.so.6          [.] malloc
     2.16%  xarope   xarope             [.] xarope::decimal_to_u64
     2.13%  xarope   xarope             [.] hashbrown::raw::RawTable<T,A>::reserve_rehash
```

## Memory profiling

```bash
➜ heaptrack_print heaptrack.xarope.*.zst 2>/dev/null | grep -E "^(total|peak|leaked|calls)"
total runtime: 42.52s.
calls to allocation functions: 300000072 (7055339/s)
peak heap memory consumption: 1.71G
peak RSS (including heaptrack overhead): 1.69G
total memory leaked: 456B

➜ heaptrack_print heaptrack.xarope.*.zst 2>/dev/null | \
                            awk '/^[0-9]+ calls/{call=$0; getline; gsub(/^ +/,"",$0); print call " " $0}' | head -10
300000006 calls to allocation functions with 453B peak consumption from _$LT$csv..reader..StringRecordsIter$LT$R$GT$$u20$as$u20$core..iter..traits..iterator..Iterator$GT$::next::h1a735da0152cfd46
100000000 calls with 88B peak consumption from: xarope::main::ha5e2747e78b9d25f
100000000 calls with 32B peak consumption from: xarope::main::ha5e2747e78b9d25f
100000000 calls with 29B peak consumption from: xarope::main::ha5e2747e78b9d25f
1 calls with 88B peak consumption from: xarope::main::ha5e2747e78b9d25f
1 calls with 32B peak consumption from: xarope::main::ha5e2747e78b9d25f
25 calls to allocation functions with 1.71G peak consumption from _ZN9hashbrown3raw21RawTable$LT$T$C$A$GT$14reserve_rehash17hf56feaa834f5677dE.llvm.13546637831624767653
25 calls with 1.71G peak consumption from: _$LT$std..collections..hash..map..HashMap$LT$K$C$V$C$S$GT$$u20$as$u20$xarope..HashMapInsertUniqueExt$LT$K$C$V$GT$$GT$::insert_unique::h42eaad9e2461dcda
11 calls to allocation functions with 102.42K peak consumption from _ZN9hashbrown3raw21RawTable$LT$T$C$A$GT$14reserve_rehash17hb42c0849740ebe74E.llvm.13546637831624767653
8 calls with 102.42K peak consumption from: _$LT$std..collections..hash..map..HashMap$LT$K$C$V$C$S$GT$$u20$as$u20$xarope..HashMapInsertUniqueExt$LT$K$C$V$GT$$GT$::insert_unique::h631f071a7c88c6e5
```

## Results

This version replaced `std::collections::HashMap` with `rustc_hash::FxHashMap`:

- **~17% faster** (13.16s → 10.95s)
- Switched from SipHash (cryptographically secure, slower) to FxHash (fast, non-cryptographic)
- Hashing dropped from 20% of CPU time to negligible
- No change in memory allocations - this was a pure CPU optimization
- CSV parsing now dominates the profile (~54%), indicating we've reached I/O-bound territory
