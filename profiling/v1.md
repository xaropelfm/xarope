# V1

## Benchmark

```bash
➜ hyperfine --warmup 3 './target/release/xarope samples/100M.csv'
Benchmark 1: ./target/release/xarope samples/100M.csv
  Time (mean ± σ):     21.888 s ±  0.381 s    [User: 21.268 s, System: 0.567 s]
  Range (min … max):   21.483 s … 22.659 s    10 runs
```

## CPU profiling

```bash
➜ perf record -g --call-graph dwarf ./target/release/xarope samples/100M.csv

➜ perf report --stdio --no-children 2>/dev/null | grep -E "^\s+[0-9]" | head -10
    11.02%  xarope   xarope             [.] csv::byte_record::ByteRecord::trim
     9.81%  xarope   xarope             [.] csv_core::reader::Reader::read_record
     9.04%  xarope   xarope             [.] csv::string_record::StringRecord::trim
     8.42%  xarope   xarope             [.] core::hash::BuildHasher::hash_one
     6.54%  xarope   xarope             [.] <csv::reader::DeserializeRecordsIter<R,D> as core::iter::traits::iterator::Iterator>::next
     6.29%  xarope   xarope             [.] <rust_decimal::decimal::Decimal as num_traits::cast::ToPrimitive>::to_u64
     5.86%  xarope   libc.so.6          [.] __libc_calloc
     4.93%  xarope   xarope             [.] xarope::main
     3.54%  xarope   xarope             [.] <&mut csv::deserializer::DeRecordWrap<T> as serde_core::de::Deserializer>::deserialize_struct
     3.05%  xarope   xarope             [.] core::hash::BuildHasher::hash_one
```

## Memory profiling

```bash
➜ heaptrack ./target/release/xarope samples/100M.csv

➜ heaptrack_print heaptrack.xarope.*.zst 2>/dev/null | grep -E "^(total|peak|leaked|calls)"
total runtime: 97.06s.
calls to allocation functions: 659225539 (6792078/s)
peak heap memory consumption: 1.71G
peak RSS (including heaptrack overhead): 1.71G
total memory leaked: 456B

➜ heaptrack_print heaptrack.xarope.*.zst 2>/dev/null | \
                awk '/^[0-9]+ calls/{call=$0; getline; gsub(/^ +/,"",$0); print call " " $0}' | head -10
300000003 calls to allocation functions with 287B peak consumption from csv::string_record::StringRecord::trim::h817b75961cb06627
100000000 calls with 29B peak consumption from: _$LT$csv..reader..DeserializeRecordsIter$LT$R$C$D$GT$$u20$as$u20$core..iter..traits..iterator..Iterator$GT$::next::h9c2d6b929000d543
100000000 calls with 32B peak consumption from: _$LT$csv..reader..DeserializeRecordsIter$LT$R$C$D$GT$$u20$as$u20$core..iter..traits..iterator..Iterator$GT$::next::h9c2d6b929000d543
100000000 calls with 88B peak consumption from: _$LT$csv..reader..DeserializeRecordsIter$LT$R$C$D$GT$$u20$as$u20$core..iter..traits..iterator..Iterator$GT$::next::h9c2d6b929000d543
1 calls with 18B peak consumption from: csv::reader::Reader$LT$R$GT$::set_headers_impl::h50c7e94895008ca8
1 calls with 32B peak consumption from: csv::reader::Reader$LT$R$GT$::set_headers_impl::h50c7e94895008ca8
300000003 calls to allocation functions with 138B peak consumption from csv::byte_record::ByteRecord::trim::h00945277a89eaa61
100000000 calls with 0B peak consumption from: _$LT$csv..reader..DeserializeRecordsIter$LT$R$C$D$GT$$u20$as$u20$core..iter..traits..iterator..Iterator$GT$::next::h9c2d6b929000d543
100000000 calls with 0B peak consumption from: _$LT$csv..reader..DeserializeRecordsIter$LT$R$C$D$GT$$u20$as$u20$core..iter..traits..iterator..Iterator$GT$::next::h9c2d6b929000d543
100000000 calls with 0B peak consumption from: _$LT$csv..reader..DeserializeRecordsIter$LT$R$C$D$GT$$u20$as$u20$core..iter..traits..iterator..Iterator$GT$::next::h9c2d6b929000d543
```
